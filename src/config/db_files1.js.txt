import { Sequelize } from "sequelize";
import config from "./index.js";

const sequelize = new Sequelize(
  config.DATABASE_NAME,
  config.DATABASE_USERNAME,
  config.DATABASE_PASSWORD,
  {
    dialect: config.DATABASE_DIALECT,
    dialectOptions: {
      ssl: {
        require: config.ENVIRONMENT !== "development" ?? false,
        rejectUnauthorized: false,
      },
    },
    port: config.DATABASE_PORT,
    host: config.DATABASE_HOST,
    logging: (msg) => console.log(msg),
  }
);

// Test the connection and sync database
export const connectDB = async () => {
  try {
    // First, try to connect to the database
    await sequelize.authenticate();
    console.log(`Connected to ${config.DATABASE_NAME} via Sequelize`);

    // Sync all models - this will create tables if they don't exist
    await sequelize.sync({ alter: true });
    console.log("Database tables synchronized successfully");
  } catch (error) {
    console.error("Failed to connect to DB:", error.message);
    process.exit(1);
  }
};

export default sequelize;
